using WpfScheduledApp20250729.Controls;
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Threading.Tasks;
using WpfScheduledApp20250729;
using WpfScheduledApp20250729.Interfaces;
using WpfScheduledApp20250729.Services;
using WpfScheduledApp20250729.Models;

namespace WpfScheduledApp20250729.ViewModels
{
    class ReadTasksViewModel : NotificationObject
    {
        private readonly IWindowService _windowService;
        private readonly IGlobalHotKeyService _globalHotKeyService;
        private readonly ITaskActionService _taskActionService;
        private readonly IResultService _resultService;
        private readonly HighTaskService _highTaskService;
        private readonly MiddleTaskService _middleTaskService;
        private readonly LowTaskService _lowTaskService;
        private readonly ArchitectureService _architectureService;
        private readonly ProjectService _projectService;

        private ObservableCollection<object> _tasks = new();
        public ObservableCollection<object> Tasks 
        { 
            get => _tasks; 
            set => SetProperty(ref _tasks, value); 
        }

        private UserControl _currentView = new ReadTaskControl();
        public UserControl CurrentView
        {
            get => _currentView;
            set => SetProperty(ref _currentView, value);
        }

        private bool _letsStartCheckBox = false;
        public bool LetsStartCheckBox
        {
            get => _letsStartCheckBox;
            set => SetProperty(ref _letsStartCheckBox, value);
        }

        // Âõ≥Êõ∏È§®Ë°®Á§∫Ê©üËÉΩ
        private bool _isLibraryView = false;
        public bool IsLibraryView
        {
            get => _isLibraryView;
            set => SetProperty(ref _isLibraryView, value);
        }

        // „Éá„Ç∂„Ç§„É≥„ÉÜ„Éº„ÉûÁÆ°ÁêÜ
        public enum DesignTheme
        {
            Gaming = 0,
            Library = 1,
            Terminator = 2,
            Japanese = 3,
            Monochrome = 4
        }

        private DesignTheme _currentTheme = DesignTheme.Gaming;
        public DesignTheme CurrentTheme
        {
            get => _currentTheme;
            set => SetProperty(ref _currentTheme, value);
        }

        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„ÅàÁî®„Éó„É≠„Éë„ÉÜ„Ç£
        public bool IsGamingTheme => CurrentTheme == DesignTheme.Gaming;
        public bool IsLibraryTheme => CurrentTheme == DesignTheme.Library;
        public bool IsTerminatorTheme => CurrentTheme == DesignTheme.Terminator;
        public bool IsJapaneseTheme => CurrentTheme == DesignTheme.Japanese;
        public bool IsMonochromeTheme => CurrentTheme == DesignTheme.Monochrome;

        private ObservableCollection<HTLSectionViewModel> _htlSections = new();
        public ObservableCollection<HTLSectionViewModel> HTLSections
        {
            get => _htlSections;
            set => SetProperty(ref _htlSections, value);
        }

        public DelegateCommand SearchCommand { get; }
        public DelegateCommand HighTaskCommand { get; }
        public DelegateCommand MiddleTaskCommand { get; }
        public DelegateCommand LowTaskCommand { get; }
        public DelegateCommand AddTaskCommand { get; }
        public DelegateCommand ActionTaskCommand { get; }
        public DelegateCommand AppSettingsCommand { get; }
        public DelegateCommand DatabaseSettingsCommand { get; }
        public DelegateCommand ToggleViewCommand { get; }
        public DelegateCommand SwitchThemeCommand { get; }

        public ReadTasksViewModel(IWindowService windowService, IGlobalHotKeyService globalHotKeyService, ITaskActionService taskActionService, IResultService resultService, HighTaskService highTaskService, MiddleTaskService middleTaskService, LowTaskService lowTaskService, ArchitectureService architectureService, ProjectService projectService)
        {
            _windowService = windowService;
            _globalHotKeyService = globalHotKeyService;
            _taskActionService = taskActionService;
            _resultService = resultService;
            _highTaskService = highTaskService;
            _middleTaskService = middleTaskService;
            _lowTaskService = lowTaskService;
            _architectureService = architectureService;
            _projectService = projectService;

            // „Éõ„ÉÉ„Éà„Ç≠„Éº„Ç§„Éô„É≥„Éà„ÅÆË≥ºË™≠
            _globalHotKeyService.HotKeyPressed += OnHotKeyPressed;

            // „Ç≥„Éû„É≥„Éâ„ÅÆÂàùÊúüÂåñ
            SearchCommand = new DelegateCommand(_ => ExecuteSearch(), _ => true);
            HighTaskCommand = new DelegateCommand(_ => ShowHighTasks(), _ => true);
            MiddleTaskCommand = new DelegateCommand(_ => ShowMiddleTasks(), _ => true);
            LowTaskCommand = new DelegateCommand(_ => ShowLowTasks(), _ => true);
            AddTaskCommand = new DelegateCommand(_ => ShowTaskAction(), _ => true);
            ActionTaskCommand = new DelegateCommand(_ => ShowTaskAction(), _ => true);
            AppSettingsCommand = new DelegateCommand(_ => ShowAppSettings(), _ => true);
            DatabaseSettingsCommand = new DelegateCommand(_ => ShowDatabaseSettings(), _ => true);
            ToggleViewCommand = new DelegateCommand(_ => ToggleView(), _ => true);
            SwitchThemeCommand = new DelegateCommand(_ => SwitchTheme(), _ => true);
            
            // ÂàùÊúü„Éì„É•„Éº„ÇíË®≠ÂÆö
            LoadInitialView();
        }

        private void ExecuteSearch()
        {
            // Ê§úÁ¥¢Âá¶ÁêÜ„ÅÆÂÆüË£Ö
        }

        private void ShowAppSettings()
        {
            // „Ç¢„Éó„É™Ë®≠ÂÆöÁîªÈù¢„ÇíË°®Á§∫
        }

        private void ShowDatabaseSettings()
        {
            // „Éá„Éº„Çø„Éô„Éº„ÇπË®≠ÂÆöÁîªÈù¢„ÇíË°®Á§∫
        }

        private async void ShowHighTasks()
        {
            var highTasks = await _highTaskService.GetAllAsync();
            Tasks.Clear();
            foreach (var task in highTasks)
            {
                Tasks.Add(task);
            }
            CurrentView = new HighTaskControl();
        }

        private async void ShowMiddleTasks()
        {
            var middleTasks = await _middleTaskService.GetAllAsync();
            Tasks.Clear();
            foreach (var task in middleTasks)
            {
                Tasks.Add(task);
            }
            CurrentView = new ReadTaskControl();
        }

        private async void ShowLowTasks()
        {
            var lowTasks = await _lowTaskService.GetAllAsync();
            Tasks.Clear();
            foreach (var task in lowTasks)
            {
                Tasks.Add(task);
            }
            CurrentView = new LowTaskControl();
        }

        private void OnHotKeyPressed(object sender, HotKeyPressedEventArgs e)
        {
            switch (e.HotKeyName)
            {
                case "ActivateWindow":
                    // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Éà
                    WindowActivateRequested?.Invoke(this, EventArgs.Empty);
                    break;
                case "AddTask":
                    // „Çø„Çπ„ÇØËøΩÂä†„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíË°®Á§∫
                    _windowService.ShowAddTaskWindow();
                    break;
                case "Motivation1":
                case "Motivation2":
                case "Motivation3":
                case "Motivation4":
                case "Motivation5":
                case "Motivation6":
                case "Motivation7":
                case "Motivation8":
                case "Motivation9":
                case "Motivation0":
                    // „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥ËøΩÂä†
                    HandleMotivation(e.HotKeyName);
                    break;
            }
        }

        private void HandleMotivation(string hotKeyName)
        {
            // „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
            string motivationText = GetMotivationText(hotKeyName);
            MessageBox.Show($"{motivationText} „É¨„Ç≥„Éº„Éâ„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü„ÄÇ", "üéÆ MOTIVATION BOOST!");
            
            if (hotKeyName == "Motivation1")
            {
                MessageBox.Show("motivation„Åå„Å™„ÅÑ„Åª„ÅÜ„Åå„ÄÅ‰ΩôË®à„Å™„Åì„Å®ËÄÉ„Åà„Å™„Åè„Å¶Ê©üÊ¢∞ÁöÑ„Å´„ÇÑ„Çä„ÇÑ„Åô„ÅÑ„Åã„Çâ„ÄÅ‰ªä„ÅÆ„ÅäÂâç„ÅØÊúÄÈ´òDA‚òÖ", "‚ö° GAMING MODE ACTIVATED!");
            }
        }

        private string GetMotivationText(string hotKeyName)
        {
            return hotKeyName switch
            {
                "Motivation1" => "üöÄ BOOST LEVEL 1",
                "Motivation2" => "‚ö° ENERGY SURGE",
                "Motivation3" => "üî• FIRE MODE",
                "Motivation4" => "üíé DIAMOND FOCUS",
                "Motivation5" => "üåü STAR POWER",
                "Motivation6" => "üéØ PRECISION TARGET",
                "Motivation7" => "‚≠ê LEGENDARY",
                "Motivation8" => "üèÜ CHAMPION",
                "Motivation9" => "üëë MASTER",
                "Motivation0" => "üéÆ ULTIMATE GAMER",
                _ => "UNKNOWN MOTIVATION"
            };
        }

        private void ShowTaskAction()
        {
            // „Ç≤„Éº„Éü„É≥„Ç∞‰ªïÊßò„ÅÆTaskAction„ÇíË°®Á§∫
            var taskActionViewModel = new TaskActionViewModel(_taskActionService, 1); // „Çµ„É≥„Éó„É´„Çø„Çπ„ÇØID
            taskActionViewModel.TaskCompleted += OnTaskCompleted;
            
            TaskActionRequested?.Invoke(this, new TaskActionRequestedEventArgs(taskActionViewModel));
        }

        private void OnTaskCompleted(object sender, TaskActionViewModel.TaskCompletedEventArgs e)
        {
            // ÁµêÊûúÁîªÈù¢„ÇíË°®Á§∫
            var resultViewModel = new GamingResultViewModel(_resultService, e.Task, e.IsCompleted);
            resultViewModel.ResultProcessed += OnResultProcessed;
            
            ResultRequested?.Invoke(this, new ResultRequestedEventArgs(resultViewModel));
        }

        private void OnResultProcessed(object sender, GamingResultViewModel.ResultProcessedEventArgs e)
        {
            // ÁµêÊûúÂá¶ÁêÜÂæå„ÅÆÂá¶ÁêÜ
            MessageBox.Show($"üéÆ Action completed: {e.Action}", "GAMING RESULT");
        }

        #region Events

        public event EventHandler WindowActivateRequested;
        public event EventHandler<TaskActionRequestedEventArgs> TaskActionRequested;
        public event EventHandler<ResultRequestedEventArgs> ResultRequested;
        public event EventHandler<ThemeChangedEventArgs> ThemeChanged;

        public class TaskActionRequestedEventArgs : EventArgs
        {
            public TaskActionViewModel ViewModel { get; }
            
            public TaskActionRequestedEventArgs(TaskActionViewModel viewModel)
            {
                ViewModel = viewModel;
            }
        }

        public class ResultRequestedEventArgs : EventArgs
        {
            public GamingResultViewModel ViewModel { get; }
            
            public ResultRequestedEventArgs(GamingResultViewModel viewModel)
            {
                ViewModel = viewModel;
            }
        }

        public class ThemeChangedEventArgs : EventArgs
        {
            public DesignTheme NewTheme { get; }
            
            public ThemeChangedEventArgs(DesignTheme newTheme)
            {
                NewTheme = newTheme;
            }
        }

        #endregion

        #region Âõ≥Êõ∏È§®Ë°®Á§∫Ê©üËÉΩ

        private void LoadInitialView()
        {
            // ÂàùÊúü„ÅØ„ÉÜ„Éº„Éñ„É´„Éì„É•„Éº„ÇíË°®Á§∫
            CurrentView = new ReadTaskControl();
            LoadLibraryData();
        }

        private void ToggleView()
        {
            IsLibraryView = !IsLibraryView;
            
            if (IsLibraryView)
            {
                // Âõ≥Êõ∏È§®Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà
                var libraryControl = new LibraryTaskControl();
                libraryControl.DataContext = this;
                CurrentView = libraryControl;
                LoadLibraryData();
            }
            else
            {
                // „ÉÜ„Éº„Éñ„É´Ë°®Á§∫„Å´Êàª„Åô
                CurrentView = new ReadTaskControl();
                LoadTableData();
            }
        }

        private void SwitchTheme()
        {
            // „ÉÜ„Éº„Éû„ÇíÈ†ÜÁï™„Å´Âàá„ÇäÊõø„Åà: Gaming ‚Üí Library ‚Üí Terminator ‚Üí Japanese ‚Üí Monochrome ‚Üí Gaming...
            CurrentTheme = (DesignTheme)(((int)CurrentTheme + 1) % 5);
            
            // „Éó„É≠„Éë„ÉÜ„Ç£Â§âÊõ¥ÈÄöÁü•
            OnPropertyChanged(nameof(IsGamingTheme));
            OnPropertyChanged(nameof(IsLibraryTheme));
            OnPropertyChanged(nameof(IsTerminatorTheme));
            OnPropertyChanged(nameof(IsJapaneseTheme));
            OnPropertyChanged(nameof(IsMonochromeTheme));
            
            // „ÉÜ„Éº„Éû„Å´Âøú„Åò„Åü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            string themeMessage = CurrentTheme switch
            {
                DesignTheme.Gaming => "üéÆ GAMING MODE ACTIVATED!",
                DesignTheme.Library => "üìö LIBRARY MODE ACTIVATED!",
                DesignTheme.Terminator => "ü§ñ TERMINATOR MODE ACTIVATED! TARGET ACQUIRED.",
                DesignTheme.Japanese => "üå∏ ÂíåÈ¢®„É¢„Éº„ÉâËµ∑ÂãïÔºÅÈõÖ„Å™‰∏ñÁïå„Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ",
                DesignTheme.Monochrome => "‚ö´ MONOCHROME MODE ACTIVATED! SIMPLICITY IS BEAUTY.",
                _ => "UNKNOWN THEME"
            };
            
            MessageBox.Show(themeMessage, "THEME SWITCHED");
            
            // Window„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„ÄÅWindow„Å∏„Ç§„Éô„É≥„ÉàÈÄöÁü•
            ThemeChanged?.Invoke(this, new ThemeChangedEventArgs(CurrentTheme));
        }

        private async void LoadLibraryData()
        {
            try
            {
                // LowTask„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
                var lowTasks = await GetTodayLowTasksAsync();
                
                // HTLÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
                var htlGroups = lowTasks.GroupBy(t => t.HowToLearnName).ToList();
                
                HTLSections.Clear();
                
                foreach (var htlGroup in htlGroups)
                {
                    var section = new HTLSectionViewModel
                    {
                        HTLName = htlGroup.Key,
                        HTLIcon = HTLStatistics.GetHTLIcon(htlGroup.Key),
                        ClearCount = await GetHTLClearCountAsync(htlGroup.Key)
                    };
                    
                    // „Çø„Çπ„ÇØ„ÇíLibraryTaskViewModel„Å´Â§âÊèõ
                    foreach (var task in htlGroup)
                    {
                        var libraryTask = LibraryTaskViewModel.FromLowTask(task);
                        section.Tasks.Add(libraryTask);
                    }
                    
                    section.UpdateProgress();
                    HTLSections.Add(section);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Âõ≥Êõ∏È§®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: {ex.Message}", "„Ç®„É©„Éº");
            }
        }

        private void LoadTableData()
        {
            // Êó¢Â≠ò„ÅÆ„ÉÜ„Éº„Éñ„É´„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂá¶ÁêÜ
            ShowLowTasks();
        }

        private async Task<System.Collections.Generic.List<Models.Entities.LowTask>> GetTodayLowTasksAsync()
        {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØLowTaskService„Çí‰ΩøÁî®
            // ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæó„Åô„Çã‰ªÆÂÆüË£Ö
            return await Task.FromResult(new System.Collections.Generic.List<Models.Entities.LowTask>
            {
                new Models.Entities.LowTask
                {
                    Id = 1,
                    Description = "FreePlane MM„Éï„Ç°„Ç§„É´‰ΩúÊàê",
                    EstimatedTime = 30,
                    ExecutionDate = DateOnly.FromDateTime(DateTime.Today),
                    ExecutionTime = new TimeOnly(9, 0),
                    LastClearedAt = DateTime.Today.AddHours(-1),
                    HowToLearnName = "FreePlane",
                    MiddleTaskMName = "Â≠¶ÁøíË®àÁîª",
                    ProjectName = "Áü•Ë≠òÁÆ°ÁêÜ",
                    MiddleTaskId = 1,
                    ProjectId = 1
                },
                new Models.Entities.LowTask
                {
                    Id = 2,
                    Description = "PDFË≥áÊñôË™≠„ÅøËæº„Åø",
                    EstimatedTime = 45,
                    ExecutionDate = DateOnly.FromDateTime(DateTime.Today),
                    ExecutionTime = new TimeOnly(10, 0),
                    LastClearedAt = DateTime.Today.AddHours(2),
                    HowToLearnName = "PDF",
                    MiddleTaskMName = "Ë≥áÊñôÁ†îÁ©∂",
                    ProjectName = "ÊäÄË°ìÂ≠¶Áøí",
                    MiddleTaskId = 2,
                    ProjectId = 1
                },
                new Models.Entities.LowTask
                {
                    Id = 3,
                    Description = "ÂãïÁîªÊïôÊùêË¶ñËÅ¥",
                    EstimatedTime = 60,
                    ExecutionDate = DateOnly.FromDateTime(DateTime.Today),
                    ExecutionTime = new TimeOnly(14, 0),
                    LastClearedAt = DateTime.Today.AddHours(-2),
                    HowToLearnName = "Movie",
                    MiddleTaskMName = "ÂãïÁîªÂ≠¶Áøí",
                    ProjectName = "„Çπ„Ç≠„É´„Ç¢„ÉÉ„Éó",
                    MiddleTaskId = 3,
                    ProjectId = 2
                },
                new Models.Entities.LowTask
                {
                    Id = 4,
                    Description = "Web„Éö„Éº„Ç∏Ë™øÊüª",
                    EstimatedTime = 25,
                    ExecutionDate = DateOnly.FromDateTime(DateTime.Today),
                    ExecutionTime = new TimeOnly(16, 0),
                    LastClearedAt = DateTime.Today.AddHours(-3),
                    HowToLearnName = "WebPage",
                    MiddleTaskMName = "ÊÉÖÂ†±ÂèéÈõÜ",
                    ProjectName = "„É™„Çµ„Éº„ÉÅ",
                    MiddleTaskId = 4,
                    ProjectId = 2
                }
            });
        }

        private async Task<int> GetHTLClearCountAsync(string htlName)
        {
            // HTLÂà•„ÅÆÁ¥ØË®à„ÇØ„É™„Ç¢ÂõûÊï∞„ÇíÂèñÂæóÔºà‰ªÆÂÆüË£ÖÔºâ
            return await Task.FromResult(htlName switch
            {
                "FreePlane" => 15,
                "PDF" => 23,
                "Movie" => 8,
                "WebPage" => 12,
                _ => 5
            });
        }

        #endregion
    }
}